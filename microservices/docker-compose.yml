version: '3.4'

services:

  pantry-manager:
    build:
      context: ./microservice.pantrymanager/src/microservice.pantrymanager/
      dockerfile: Dockerfile
    ports:
      - 58798:80
    depends_on:
      - redis
      - placement
    networks:
      - dapr-network
  
  pantry-manager-dapr:
    image: "daprio/daprd:edge"
    command: ["./daprd",
      "-app-id", "pantry-manager",
      "-placement-host-address", "placement:50006",
      "-components-path", "/microservices/components"]
    volumes:
      - "./components/:/components"
    depends_on:
      - pantry-manager
    network_mode: "service:pantry-manager"

  product-manager:
    build:
      context: ./microservice.productmanager/src/microservice.productmanager/
      dockerfile: Dockerfile
    ports:
      - 40466:80
    depends_on:
      - redis
      - placement
    networks:
      - dapr-network

  product-manager-dapr:
    image: "daprio/daprd:edge"
    command: ["./daprd",
      "-app-id", "product-manager",
      "-placement-host-address", "placement:50006",
      "-components-path", "/microservices/components"]
    volumes:
      - "./components/:/components"
    depends_on:
      - product-manager
    network_mode: "service:product-manager"
  
  recipe-manager:
    build:
      context: ./microservice.recipemanager/src/microservice.recipemanager/
      dockerfile: Dockerfile
    ports:
      - 16681:80
    depends_on:
      - redis
      - placement
    networks:
      - dapr-network

  recipe-manager-dapr:
    image: "daprio/daprd:edge"
    command: ["./daprd",
      "-app-id", "recipe-manager",
      "-placement-host-address", "placement:50006",
      "-components-path", "/microservices/components"]
    volumes:
      - "./components/:/components"
    depends_on:
      - recipe-manager
    network_mode: "service:recipe-manager"

  scheduler:
    build:
      context: ./microservice.scheduler/src/microservice.scheduler/
      dockerfile: Dockerfile
    ports:
      - 61524:80

  identityserver:
    build:
      context: ./microservice.identityserver/src/microservice.identityserver/
      dockerfile: Dockerfile
    ports:
      - 62249:80

  ui-pantry:
    build:
      context: ./ui-pantry/
      dockerfile: Dockerfile
    ports:
      - 4200:80


  ############################
  # Dapr placement service
  ############################
  placement:
    image: "daprio/dapr"
    command: ["./placement", "-port", "50006"]
    ports:
      - "50006:50006"
    networks:
      - dapr-network

  ############################
  # Redis state store
  ############################
  redis:
    image: "redis:alpine"
    ports:
      - "6380:6379"
    networks:
      - dapr-network

networks:
  dapr-network: